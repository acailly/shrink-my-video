<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Browser title -->
    <title>Shrink my video!</title>

    <!-- Style -->
    <link rel="stylesheet" href="mvp.css" />

    <!-- PWA configuration -->
    <!-- Inspired by https://github.com/yannbertrand/pwa-demo -->
    <!-- This part was generated with https://realfavicongenerator.net/ -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="icons/favicon-16x16.png"
    />
    <link rel="manifest" href="site.webmanifest" />
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5" />
    <link rel="shortcut icon" href="favicon.ico" />
    <meta name="msapplication-TileColor" content="#ffc40d" />
    <meta name="msapplication-config" content="icons/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <!-- This part was generated with https://appsco.pe/developer/splash-screens -->
    <link
      href="splashscreens/iphone5_splash.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/iphone6_splash.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/iphoneplus_splash.png"
      media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/iphonex_splash.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/iphonexr_splash.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/iphonexsmax_splash.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/ipad_splash.png"
      media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/ipadpro1_splash.png"
      media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/ipadpro3_splash.png"
      media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />
    <link
      href="splashscreens/ipadpro2_splash.png"
      media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image"
    />

    <!-- Filled with help from https://www.heymeta.com/ -->

    <!-- HTML Meta Tags -->
    <meta name="Description" content="Online video size reducer" />

    <!-- Google / Search Engine Tags -->
    <meta itemprop="name" content="Shrink my video!" />
    <meta itemprop="description" content="Online video size reducer" />
    <meta
      itemprop="image"
      content="https://acailly.github.io/shrink-my-video/icons/android-chrome-192x192.png"
    />

    <!-- Facebook Meta Tags -->
    <meta property="og:title" content="Shrink my video!" />
    <meta property="og:description" content="Online video size reducer" />
    <meta
      property="og:image"
      content="https://acailly.github.io/shrink-my-video/icons/android-chrome-192x192.png"
    />
    <meta property="og:image:width" content="220" />
    <meta property="og:image:height" content="201" />
    <meta
      property="og:url"
      content="https://acailly.github.io/shrink-my-video/"
    />
    <meta property="og:type" content="website" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:title" content="Shrink my video!" />
    <meta name="twitter:description" content="Online video size reducer" />
    <meta
      name="twitter:image"
      content="https://acailly.github.io/shrink-my-video/icons/android-chrome-192x192.png"
    />
    <meta name="twitter:image:alt" content="Logo of Shrink my video! tool" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- See https://github.com/ffmpegwasm/ffmpeg.wasm/issues/102#issuecomment-722081362 -->
    <!-- I put it here in case this works one day, it doesn't at the moment -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />

    <!-- Custom style -->
    <style>
      header > nav {
        margin-bottom: 0em;
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <a href="https://acailly.github.io/shrink-my-video/"
          ><img
            alt="Shrink my video!"
            src="icons/android-chrome-192x192.png"
            height="70"
        /></a>
        <ul>
          <li>Home</li>
          <li><a href="#why">Why this tool?</a></li>
          <li><a href="#what">What does it do?</a></li>
          <li><a href="#technical">How it works</a></li>
          <li>
            <a
              href="https://github.com/acailly/shrink-my-video/"
              target="_blank"
              >GitHub &nearr;</a
            >
          </li>
        </ul>
      </nav>
      <h1>Shrink my video!</h1>
      <p>ðŸŒ³ Upload your video then get a smaller one, <b>easy!</b></p>
      <p>
        <i
          >Privacy note: The video stays on your computer, nothing is sent
          anywhere, it even works offline!</i
        >
      </p>
    </header>
    <main>
      <section id="run">
        <form>
          <label for="uploader">Import your file</label>
          <input type="file" id="uploader" />
          <label
            >Select shrinking techniques (<a href="#what">more details</a
            >)</label
          >
          <p>
            <span style="margin-left: 5px; margin-right: 3px">âœ”</span> Apply
            settings from The Shift Project (720p, CRF 22, 160 kbits/s)
            <a href="#what">(?)</a>
          </p>
          <div>
            <input
              type="checkbox"
              id="lower-video-resolution"
              name="shrink"
              value="lower-video-resolution"
            />
            <label for="lower-video-resolution"
              >Lower video resolution (480p)</label
            >
          </div>
          <div>
            <input
              type="checkbox"
              id="lower-video-quality"
              name="shrink"
              value="lower-video-quality"
            />
            <label for="lower-video-quality"
              >Lower video quality (CRF 28)</label
            >
          </div>
          <div>
            <input
              type="checkbox"
              id="lower-audio-bitrate"
              name="shrink"
              value="lower-audio-bitrate"
            />
            <label for="lower-audio-bitrate"
              >Lower audio bitrate (56 kbits/s)</label
            >
          </div>
          <div>
            <input
              type="checkbox"
              id="image-every-5-seconds"
              name="shrink"
              value="image-every-5-seconds"
            />
            <label for="image-every-5-seconds">One image every 5 seconds</label>
          </div>
          <div>
            <input
              type="checkbox"
              id="black-and-white"
              name="shrink"
              value="black-and-white"
            />
            <label for="black-and-white">Black and white</label>
          </div>
          <button id="start-button">Start</button>
          <progress id="progress" style="display: none"></progress>
          <div id="result" style="display: none">
            <label>Here is your shrinked video!</label>
            <video id="player" controls></video>
            <br />
            <p>
              <a
                id="link-download"
                download="output.mp4"
                href="#"
                target="_blank"
                ><b>Download</b></a
              >
              <a id="link-new-tab" href="#" target="_blank"
                ><i>Open in a new tab &nearr;</i></a
              >
            </p>
          </div>
        </form>
        <header>
          <p>
            <sup>PRO TIP</sup>
            <i>
              Here are the ffmpeg settings which will be applied to your video:
            </i>
          </p>
          <code id="applied-args"></code>
        </header>
        <script src="ffmpeg.min.js"></script>
        <script>
          const { createFFmpeg, fetchFile } = FFmpeg;
          const ffmpeg = createFFmpeg({ log: true });

          const lowVideoResolutionCheckbox = document.getElementById(
            "lower-video-resolution"
          );
          lowVideoResolutionCheckbox.addEventListener("change", () =>
            updateAppliedArgsLabel()
          );
          const lowVideoQualityCheckbox = document.getElementById(
            "lower-video-quality"
          );
          lowVideoQualityCheckbox.addEventListener("change", () =>
            updateAppliedArgsLabel()
          );
          const lowAudioBitrateCheckbox = document.getElementById(
            "lower-audio-bitrate"
          );
          lowAudioBitrateCheckbox.addEventListener("change", () =>
            updateAppliedArgsLabel()
          );
          const oneImageEvery5SecondsCheckbox = document.getElementById(
            "image-every-5-seconds"
          );
          oneImageEvery5SecondsCheckbox.addEventListener("change", () =>
            updateAppliedArgsLabel()
          );
          const blackAndWhiteCheckbox =
            document.getElementById("black-and-white");
          blackAndWhiteCheckbox.addEventListener("change", () =>
            updateAppliedArgsLabel()
          );
          const appliedArgsLabel = document.getElementById("applied-args");
          const extractArgsFromForm = () => {
            let args = [];
            // Settings from The Shift Project
            //ffmpeg -i input.mp4 -s hd720 -c:v libx264 -crf 22 -vf "scale=iw*sar:ih,setsar=1" -c:a aac -b:a 160k output.mp4
            args.push("-c:v", "libx264");
            // Low video resolution
            //ffmpeg -i input.mp4 -s hd480 output.mp4
            if (lowVideoResolutionCheckbox.checked) {
              args.push("-s", "hd480");
            } else {
              args.push("-s", "hd720");
            }
            // Low video quality
            //ffmpeg -i input.mp4 -crf 28 output.mp4
            if (lowVideoQualityCheckbox.checked) {
              args.push("-crf", "28");
            } else {
              args.push("-crf", "22");
            }
            // Low audio bitrate
            //ffmpeg -i input.mp4 -c:a aac -b:a 56k output.mp4
            if (lowAudioBitrateCheckbox.checked) {
              args.push("-c:a", "aac", "-b:a", "56k");
            } else {
              args.push("-c:a", "aac", "-b:a", "160k");
            }
            let videoFilter = "scale=iw*sar:ih,setsar=1";
            // One image every 5 seconds
            //ffmpeg -i input.mp4 -vf "fps=fps=1/5" output.mp4
            if (oneImageEvery5SecondsCheckbox.checked) {
              videoFilter = videoFilter.concat(",fps=fps=1/5");
            }
            // Black and white
            //ffmpeg -i input.mp4 -vf "hue=s=0" output.mp4
            if (blackAndWhiteCheckbox.checked) {
              videoFilter = videoFilter.concat(",hue=s=0");
            }
            args.push("-vf", videoFilter);
            args.push("output.mp4");
            return args;
          };
          const updateAppliedArgsLabel = () => {
            const additionalArgs = extractArgsFromForm()
              // Little hack because no time
              .map((arg) => {
                if (arg.startsWith("scale=")) {
                  return `\"${arg}\"`;
                }
                return arg;
              });
            const argArray = ["ffmpeg", "-i", "input.mp4", ...additionalArgs];
            const args = argArray.join(" ");
            appliedArgsLabel.innerText = args;
          };
          const transcode = async () => {
            const startButton = document.getElementById("start-button");
            startButton.disabled = true;
            startButton.innerText = "Shrinking your video...";
            const progress = document.getElementById("progress");
            progress.style.display = "none";
            const result = document.getElementById("result");
            result.style.display = "none";
            const uploader = document.getElementById("uploader");
            const files = uploader.files;
            const { name } = files[0];
            // from https://stackoverflow.com/a/37511463
            const sanitizedName = name
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "");
            await ffmpeg.load();
            ffmpeg.FS("writeFile", sanitizedName, await fetchFile(files[0]));
            const additionalArgs = extractArgsFromForm();
            const args = ["-i", sanitizedName, ...additionalArgs];
            console.log("Running FFMPEG command with args:", args);
            progress.style.display = "block";
            ffmpeg.setProgress(({ ratio }) => {
              progress.value = ratio;
            });
            await ffmpeg.run(...args);
            const data = ffmpeg.FS("readFile", "output.mp4");
            const video = document.getElementById("player");
            const blobURL = URL.createObjectURL(
              new Blob([data.buffer], { type: "video/mp4" })
            );
            video.src = blobURL;
            const linkToAnotherTab = document.getElementById("link-new-tab");
            linkToAnotherTab.href = blobURL;
            const downloadLink = document.getElementById("link-download");
            downloadLink.href = blobURL;
            progress.style.display = "none";
            result.style.display = "block";
            startButton.disabled = false;
            startButton.innerText = "Start";
          };
          document
            .getElementById("start-button")
            .addEventListener("click", (e) => {
              e.preventDefault();
              transcode();
            });
          updateAppliedArgsLabel();
        </script>
      </section>
      <hr />
      <article id="why">
        <header>
          <h2>Why this tool?</h2>
          <p>
            TL;DR; to help reduce the environmental footprint of the digital
            world
          </p>
        </header>
        <p>
          This tool aims to humbly participate in stopping the race for ever
          more quality and bandwidth (8K resolution, 5G network, etc.) by
          offering a simple way to radically reduce the size of a video.
        </p>
        <p>
          The digital worldâ€™s contribution to the footprint of humanity is
          currently around 4% (see
          <a
            href="https://www.greenit.fr/environmental-footprint-of-the-digital-world/"
            target="_blank"
            >this report from GreenIT.fr</a
          >
          and
          <a
            href="https://theshiftproject.org/en/article/lean-ict-our-new-report/"
            target="_blank"
            >this another report from The Shift Project</a
          >). This is more than
          <a
            href="https://theshiftproject.org/en/article/lean-ict-our-new-report/"
            target="_blank"
            >the aviation</a
          >, and it is predicted to grow in the future.
        </p>
        <p>
          Online video does <b>NOT</b> represent the main impact of the digital
          world, <b>manufacturing is a much bigger deal</b>. But reducing the
          size of a video can help <b>keep our old devices</b> that have limited
          bandwidth and limited computing power, instead of buying new ones.
        </p>
      </article>
      <hr />
      <article id="what">
        <header>
          <h2>What does it do?</h2>
        </header>
        <h3>
          Apply settings from The Shift Project (720p, CRF 22, 160 kbits/s)
        </h3>
        <p>
          The Shift Project has published a guide for reducing the size of a
          video while maintaining a good quality
        </p>
        <p>
          You can download it
          <a
            href="https://theshiftproject.org/en/guide-reduce-weight-video-5-minutes/"
            target="_blank"
            >here</a
          >.
        </p>
        <p>
          Basically, it reduces the video resolution to 720p and the audio
          bitrate to 160 kbits/s. The Constant Rate Factor (CRF) is set to 22.
        </p>
        <h3>Lower video resolution (480p)</h3>
        <p>
          It reduces the video resolution to 480p. Don't watch it on your 4K TV,
          otherwise it is OK.
        </p>
        <h3>Lower video quality (CRF 28)</h3>
        <p>
          It reduces the Constant Rate Factor (CRF) to 28. You won't see tiny
          details but the essential is there.
        </p>
        <h3>Lower audio bitrate (56 kbits/s)</h3>
        <p>
          It reduces the audio bitrate to 56 kbits/s. If the audio is mainly
          speeches, it should remain audible.
        </p>
        <h3>One image every 5 seconds (!)</h3>
        <p>
          For some videos, like conferences, there is not much action and you
          can easily understand what happens even with one image every 5 seconds
        </p>
        <h3>Black and white</h3>
        <p>Aesthetic and lightweight</p>
      </article>
      <hr />
      <article id="technical">
        <header>
          <h2>How it works</h2>
          <p>Let's get into the technical details</p>
        </header>
        <p>
          This tool uses
          <a href="https://ffmpegwasm.github.io/" target="_blank"
            >FFMPEG.WASM</a
          >
          to edit the video directly in the browser!
        </p>
        <p>
          You can download
          <a href="https://ffmpeg.org/" target="_blank">FFMPEG</a>
          to try these settings directly on your computer
        </p>
        <p>
          <b>
            Apply settings from The Shift Project (720p, CRF 22, 160 kbits/s)
          </b>
        </p>
        <pre><code>ffmpeg -i input.mp4 -s hd720 -c:v libx264 -crf 22 -vf "scale=iw*sar:ih,setsar=1" -c:a aac -b:a 160k output.mp4</code></pre>
        <p><b>Lower video resolution (480p)</b></p>
        <pre><code>ffmpeg -i input.mp4 -s hd480 -c:v libx264 -crf 22 -vf "scale=iw*sar:ih,setsar=1" output.mp4</code></pre>
        <p><b>Lower video quality (CRF 28)</b></p>
        <pre><code>ffmpeg -i input.mp4 -c:v libx264 -crf 28 -vf "scale=iw*sar:ih,setsar=1" output.mp4</code></pre>
        <p><b>Lower audio bitrate (56 kbits/s)</b></p>
        <pre><code>ffmpeg -i input.mp4 -c:a aac -b:a 56k output.mp4</code></pre>
        <p><b>One image every 5 seconds</b></p>
        <pre><code>ffmpeg -i input.mp4 -vf "fps=fps=1/5" output.mp4</code></pre>
        <p><b>Black and white</b></p>
        <pre><code>ffmpeg -i input.mp4 -vf "hue=s=0" output.mp4</code></pre>
        <p>
          This whole approach is inspired by image dithering (see
          <a href="https://ditherit.com/" target="_blank">here</a> for an
          example), which removes a lot of data in the image while preserving
          its essential meaning
        </p>
      </article>
    </main>
    <footer>
      <hr />
      <p>
        Made by
        <a href="https://acailly.github.io" target="_blank"
          >Antoine Cailly &nearr;</a
        >
      </p>
      <p>
        Thanks to
        <a href="https://andybrewer.github.io/mvp/" target="_blank">MVP.css</a>
        for this beautiful minimalist stylesheet
      </p>
      <p>
        Thanks to
        <a href="https://ffmpeg.org/" target="_blank">FFMPEG</a>
        to exist
      </p>
      <p>
        Thanks to
        <a href="https://ffmpegwasm.github.io/" target="_blank">FFMPEG.WASM</a>
        to have made this wonderful tool usable in the browser
      </p>
    </footer>
    <script>
      window.addEventListener("load", () => {
        // Redirect to heroku app while FFMPEG.WASM is not compatible with Github pages hosting
        if (window.location.href.indexOf("acailly.github.io") !== -1) {
          window.location.replace(
            "https://shrink-my-video.herokuapp.com/shrink-my-video/"
          );
          return;
        }
        // Register service worker
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("./serviceworker.js")
            .then((registration) => {
              console.log("[service-worker] registered!");
            })
            .catch((error) => {
              console.error(
                "[service-worker] error during registration",
                error
              );
            });

          navigator.serviceWorker.addEventListener("controllerchange", () => {
            // This fires when the service worker controlling this page
            // changes, eg a new worker has skipped waiting and become
            // the new active worker.
            console.log("[service-worker] service worker has been updated!");
          });
        }
      });
    </script>
  </body>
</html>
